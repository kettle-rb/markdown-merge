<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: AGENTS
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "AGENTS";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: AGENTS</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="agentsmd---markdown-merge-development-guide">AGENTS.md - markdown-merge Development Guide</h1>

<h2 id="-project-overview">ğŸ¯ Project Overview</h2>

<p><code>markdown-merge</code> is a <strong>format-specific implementation of the <code>*-merge</code> gem family</strong> for Markdown files with multi-backend support. It provides intelligent Markdown file merging using AST analysis and delegates to Markly or Commonmarker backends.</p>

<p><strong>Core Philosophy</strong>: Intelligent Markdown merging that preserves structure, formatting, and links while applying updates from templates, with automatic backend selection.</p>

<p><strong>Repository</strong>: https://github.com/kettle-rb/markdown-merge<br>
<strong>Current Version</strong>: 1.0.3<br>
<strong>Required Ruby</strong>: &gt;= 3.2.0 (currently developed against Ruby 4.0.1)</p>

<h2 id="ï¸-architecture-multi-backend-adapter">ğŸ—ï¸ Architecture: Multi-Backend Adapter</h2>

<h3 id="what-markdown-merge-provides">What markdown-merge Provides</h3>

<ul>
  <li>
<strong><code>Markdown::Merge::SmartMerger</code></strong> â€“ Markdown-specific SmartMerger with backend delegation</li>
  <li>
<strong><code>Markdown::Merge::FileAnalysis</code></strong> â€“ Markdown file analysis with backend detection</li>
  <li>
<strong><code>Markdown::Merge::NodeWrapper</code></strong> â€“ Wrapper that delegates to backend-specific wrappers</li>
  <li>
<strong><code>Markdown::Merge::PartialTemplateMerger</code></strong> â€“ Section-level partial merges</li>
  <li>
<strong><code>Markdown::Merge::MergeResult</code></strong> â€“ Markdown-specific merge result</li>
  <li>
<strong><code>Markdown::Merge::BackendSelector</code></strong> â€“ Automatic backend selection (Markly â†’ Commonmarker)</li>
  <li>
<strong><code>Markdown::Merge::DebugLogger</code></strong> â€“ Markdown-specific debug logging</li>
</ul>

<h3 id="key-dependencies">Key Dependencies</h3>

<table>
  <thead>
    <tr>
      <th>Gem</th>
      <th>Role</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
<code>ast-merge</code> (~&gt; 4.0)</td>
      <td>Base classes and shared infrastructure</td>
    </tr>
    <tr>
      <td>
<code>tree_haver</code> (~&gt; 5.0)</td>
      <td>Unified parser adapter</td>
    </tr>
    <tr>
      <td>
<code>markly</code> (~&gt; 0.15)</td>
      <td>Preferred Markdown parser (optional)</td>
    </tr>
    <tr>
      <td><code>commonmarker</code></td>
      <td>Fallback Markdown parser (optional)</td>
    </tr>
    <tr>
      <td>
<code>version_gem</code> (~&gt; 1.1)</td>
      <td>Version management</td>
    </tr>
  </tbody>
</table>

<h3 id="backend-selection-strategy">Backend Selection Strategy</h3>

<p>markdown-merge automatically selects the best available backend:</p>

<table>
  <thead>
    <tr>
      <th>Priority</th>
      <th>Backend</th>
      <th>Parser</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td><code>:markly</code></td>
      <td>Markly</td>
      <td>Preferred; fast, MRI only</td>
    </tr>
    <tr>
      <td>2</td>
      <td><code>:commonmarker</code></td>
      <td>Commonmarker</td>
      <td>Fallback; also MRI only</td>
    </tr>
    <tr>
      <td>Error</td>
      <td>-</td>
      <td>-</td>
      <td>Raises error if neither available</td>
    </tr>
  </tbody>
</table>

<h2 id="-project-structure">ğŸ“ Project Structure</h2>

<pre class="code ruby"><code class="ruby">lib/markdown/merge/
â”œâ”€â”€ smart_merger.rb              # Multi-backend SmartMerger
â”œâ”€â”€ partial_template_merger.rb   # Section-level merging
â”œâ”€â”€ file_analysis.rb             # Backend-aware file analysis
â”œâ”€â”€ node_wrapper.rb              # Backend delegation wrapper
â”œâ”€â”€ merge_result.rb              # Merge result object
â”œâ”€â”€ backend_selector.rb          # Backend selection logic
â”œâ”€â”€ debug_logger.rb              # Debug logging
â””â”€â”€ version.rb

spec/markdown/merge/
â”œâ”€â”€ smart_merger_spec.rb
â”œâ”€â”€ partial_template_merger_spec.rb
â”œâ”€â”€ file_analysis_spec.rb
â”œâ”€â”€ backend_selector_spec.rb
â””â”€â”€ integration/
</code></pre>

<h2 id="-development-workflows">ğŸ”§ Development Workflows</h2>

<h3 id="running-tests">Running Tests</h3>

<pre class="code language-bash"><code class="language-bash"># Full suite
bundle exec rspec

# Single file (disable coverage threshold check)
K_SOUP_COV_MIN_HARD=false bundle exec rspec spec/markdown/merge/smart_merger_spec.rb

# Specific backend tests
bundle exec rspec --tag markly
bundle exec rspec --tag commonmarker
bundle exec rspec --tag any_markdown_merge
</code></pre>

<h3 id="coverage-reports">Coverage Reports</h3>

<pre class="code language-bash"><code class="language-bash">cd /home/pboling/src/kettle-rb/ast-merge/vendor/markdown-merge
bin/rake coverage &amp;&amp; bin/kettle-soup-cover -d
</code></pre>

<h2 id="-project-conventions">ğŸ“ Project Conventions</h2>

<h3 id="api-conventions">API Conventions</h3>

<h4 id="smartmerger-api">SmartMerger API</h4>
<ul>
  <li>
<code>merge</code> â€“ Returns a <strong>String</strong> (the merged Markdown content)</li>
  <li>
<code>merge_result</code> â€“ Returns a <strong>MergeResult</strong> object</li>
  <li>Backend is auto-selected unless explicitly specified</li>
</ul>

<p><strong>Explicit Backend Selection</strong>:</p>
<pre class="code language-ruby"><code class="language-ruby"># Auto-select (Markly â†’ Commonmarker)
merger = Markdown::Merge::SmartMerger.new(template, dest)

# Force specific backend
merger = Markdown::Merge::SmartMerger.new(template, dest, backend: :markly)
merger = Markdown::Merge::SmartMerger.new(template, dest, backend: :commonmarker)
</code></pre>

<h4 id="markdown-specific-features">Markdown-Specific Features</h4>

<p><strong>Heading-Based Sections</strong>:</p>
<pre class="code language-markdown"><code class="language-markdown"># Section 1
Content for section 1

## Subsection 1.1
Nested content

# Section 2
Content for section 2
</code></pre>

<p><strong>Freeze Blocks</strong>:</p>
<pre class="code language-markdown"><code class="language-markdown">&lt;!-- markdown-merge:freeze --&gt;
Custom content that should not be overridden
&lt;!-- markdown-merge:unfreeze --&gt;

Standard content that merges normally
</code></pre>

<h2 id="-testing-patterns">ğŸ§ª Testing Patterns</h2>

<h3 id="treehaver-dependency-tags">TreeHaver Dependency Tags</h3>

<p><strong>Available tags</strong>:</p>
<ul>
  <li>
<code>:any_markdown_merge</code> â€“ Requires any Markdown backend (Markly or Commonmarker)</li>
  <li>
<code>:markly</code> â€“ Requires Markly backend specifically</li>
  <li>
<code>:commonmarker</code> â€“ Requires Commonmarker backend specifically</li>
  <li>
<code>:markdown_parsing</code> â€“ Requires Markdown parser</li>
</ul>

<p>âœ… <strong>CORRECT</strong>:</p>
<pre class="code language-ruby"><code class="language-ruby">RSpec.describe Markdown::Merge::SmartMerger, :any_markdown_merge do
  # Skipped if no Markdown parser available
end

context &quot;with Markly backend&quot;, :markly do
  # Only runs when Markly available
end

context &quot;with Commonmarker backend&quot;, :commonmarker do
  # Only runs when Commonmarker available
end
</code></pre>

<p>âŒ <strong>WRONG</strong>:</p>
<pre class="code language-ruby"><code class="language-ruby">before do
  skip &quot;Requires Markdown parser&quot; unless markdown_available?  # DO NOT DO THIS
end
</code></pre>

<h2 id="-key-insights">ğŸ’¡ Key Insights</h2>

<ol>
  <li>
<strong>Backend auto-selection</strong>: Prefers Markly, falls back to Commonmarker automatically</li>
  <li>
<strong>Backend delegation</strong>: NodeWrapper and FileAnalysis delegate to backend-specific implementations</li>
  <li>
<strong>Cross-backend compatibility</strong>: Same API works with both backends</li>
  <li>
<strong><code>.text</code> strips formatting</strong>: When matching by text, backticks and other formatting are removed (both backends)</li>
  <li>
<strong>Freeze blocks use HTML comments</strong>: <code>&lt;!-- markdown-merge:freeze --&gt;</code>
</li>
  <li>
<strong>MRI only</strong>: Both Markly and Commonmarker require MRI</li>
</ol>

<h2 id="-common-pitfalls">ğŸš« Common Pitfalls</h2>

<ol>
  <li>
<strong>markdown-merge requires MRI</strong>: Neither backend works on JRuby or TruffleRuby</li>
  <li>
<strong>NEVER use manual skip checks</strong> â€“ Use dependency tags (<code>:any_markdown_merge</code>, <code>:markly</code>, <code>:commonmarker</code>)</li>
  <li>
<strong>Backend must be available</strong>: Raises error if neither Markly nor Commonmarker installed</li>
  <li>
<strong>Text matching strips formatting</strong> â€“ Match on plain text, not markdown syntax</li>
  <li>
<strong>Do NOT load vendor gems</strong> â€“ They are not part of this project; they do not exist in CI</li>
  <li>
<strong>Use <code>tmp/</code> for temporary files</strong> â€“ Never use <code>/tmp</code> or other system directories</li>
</ol>

<h2 id="-markdown-specific-notes">ğŸ”§ Markdown-Specific Notes</h2>

<h3 id="backend-selection">Backend Selection</h3>
<pre class="code language-ruby"><code class="language-ruby"># Check available backends
Markdown::Merge::BackendSelector.available_backends
# =&gt; [:markly] or [:commonmarker] or [:markly, :commonmarker]

# Get preferred backend
Markdown::Merge::BackendSelector.select_backend
# =&gt; :markly (if available), else :commonmarker

# Force backend
Markdown::Merge::BackendSelector.select_backend(prefer: :commonmarker)
# =&gt; :commonmarker (if available)
</code></pre>

<h3 id="node-types-both-backends">Node Types (both backends)</h3>
<pre class="code language-markdown"><code class="language-markdown">document         # Root node
heading          # # Heading
paragraph        # Regular text
code_block       # ```code```
list             # - item or 1. item
link             # [text](url)
image            # ![alt](src)
</code></pre>

<h3 id="merge-behavior">Merge Behavior</h3>
<ul>
  <li>
<strong>Headings</strong>: Matched by heading text (stripped of formatting)</li>
  <li>
<strong>Sections</strong>: Content from heading to next same-level heading</li>
  <li>
<strong>Backend delegation</strong>: FileAnalysis and NodeWrapper delegate to markly-merge or commonmarker-merge</li>
  <li>
<strong>Freeze blocks</strong>: Protect customizations from template updates</li>
  <li>
<strong>Auto-fallback</strong>: Uses Markly if available, else Commonmarker</li>
</ul>

<h3 id="testing-multi-backend-code">Testing Multi-Backend Code</h3>
<pre class="code language-ruby"><code class="language-ruby"># Test with all available backends
[:markly, :commonmarker].each do |backend|
  context &quot;with #{backend} backend&quot;, backend do
    it &quot;merges correctly&quot; do
      merger = described_class.new(template, dest, backend: backend)
      expect(merger.merge).to eq(expected)
    end
  end
end
</code></pre>
</div></div>

      <div id="footer">
  Generated on Thu Feb 19 09:34:59 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.1).
</div>

    </div>
  </body>
</html>